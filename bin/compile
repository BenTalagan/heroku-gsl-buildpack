#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

# Debug
set -x
env

BUILD_DIR=$1
CACHE_DIR=$2
VENDOR_DIR="$BUILD_DIR/vendor"
PROFILE_PATH="$BUILD_DIR/.profile.d/gsl.sh"

mkdir -p $(dirname $PROFILE_PATH)
mkdir -p $VENDOR_DIR

function set-default-env (){
  echo "export $1=\$$1:$2" >> $PROFILE_PATH
}

echo "-----> Fetching and vendoring gsl"
curl "https://s3.amazonaws.com/opendoor-deps/gsl-1.16.tar.gz" -s -o - | tar xzf - -C "$VENDOR_DIR"
mv "$VENDOR_DIR/gsl-1.16" "$VENDOR_DIR/gsl"

set-default-env PATH "/app/vendor/gsl/bin"
set-default-env LD_LIBRARY_PATH "/app/vendor/gsl/lib"
set-default-env LIBRARY_PATH "/app/vendor/gsl/lib"
set-default-env CPATH "/app/vendor/gsl/include"
